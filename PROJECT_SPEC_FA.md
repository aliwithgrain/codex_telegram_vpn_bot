# مشخصات نهایی ربات تلگرام فروش و مدیریت حجم VPN

این سند بر اساس آخرین پیام شما تهیه شده و جایگزین نسخه‌های قبلی است.

## 1) مصرف و منبع اندازه‌گیری
- منبع مصرف: پنل **3x-ui**.
- روش اتصال: **login cookie** (ورود به پنل و استفاده از session).
- واحد نمایش مصرف: **GB**.
- ریست دوره‌ای مصرف: هر **30 روز**.
- بروزرسانی مصرف از پنل: هر **1 ساعت**.
- در صورت خطا در دریافت مصرف: پیام ثابت
  - «برای بررسی وضعیت با اکانت مدیر تماس بگیرید»
- نوع نمایش مصرف: فقط مقدار عددی (بدون درصد).
- تاریخچه مصرف: نیاز نیست (فقط وضعیت فعلی).

## 2) مدل محصول و قوانین پلن
- مدل فروش: اشتراکی.
- پارامترهای پلن: زمان + حجم.
- شروع اشتراک جدید: فقط بعد از پایان کامل اشتراک قبلی (اتمام زمان یا حجم).
- دوره پلن‌ها: 30 روزه.
- پایان اشتراک: با اتمام زمان یا اتمام حجم.
- وضعیت‌های اشتراک:
  - `active`
  - `expired`
  - `depleted`
  - `disabled`
- پلن تست: فعال است.
- ارز: تومان.
- مرجوعی: ندارد.

## 3) جریان‌های ربات
### کاربر
- `/start`: ثبت‌نام + نمایش منوی اصلی.
- وضعیت اشتراک:
  - حجم باقی‌مانده
  - زمان باقی‌مانده
  - نام پلن
- خرید اشتراک:
  - انتخاب پلن
  - پرداخت کارت‌به‌کارت
  - ثبت رسید
  - تایید دستی ادمین
  - ارسال لینک بعد از تایید
- تمدید:
  - تمدید پلن فعلی
  - یا خرید پلن جدید
- فاکتور:
  - لیست پرداخت‌ها
- پشتیبانی:
  - اتصال به کانال

### ادمین
- تعداد ادمین: 1 ادمین اصلی + یک اکانت دوم مرتبط با کانال.
- امکانات:
  - تایید/رد پرداخت
  - گزارش فروش
  - مدیریت پرداخت‌ها
  - جستجوی کاربر با `telegram_id` عددی
  - مدیریت اشتراک‌ها
  - انتقال اشتراک بین کاربران
- تمام عملیات مدیریتی در `audit_logs` ثبت می‌شود.

## 4) پرداخت
- نوع پرداخت: داخل ایران.
- روش: کارت‌به‌کارت (کاملاً دستی).
- وبهوک: ندارد.
- تایید پرداخت: با دکمه تایید/رد توسط ادمین داخل ربات.

## 5) دیتابیس
- دیتابیس: MySQL.
- جدول‌ها:
  - `users`
  - `subscriptions`
  - `payments`
  - `audit_logs`
- هر کاربر می‌تواند چند اشتراک متفاوت داشته باشد.
- انتقال اشتراک بین کاربران مجاز است.
- حذف کاربر: 1 روز بعد از پایان اشتراک.
- بکاپ دیتابیس: روزانه روی همان سرور VPS.

## 6) تکنولوژی و اجرا
- زبان: Node.js.
- کتابخانه ربات: Telegraf.
- زیرساخت: VPS.
- استقرار:
  - Docker پشتیبانی شود.
  - نصب روی aaPanel ممکن باشد.
- بررسی انقضا و اعلان‌ها: هر 2 ساعت.
- مانیتورینگ خطا: فعال.

## 7) امنیت و حریم خصوصی
- ثبت نشدن توکن‌ها/کلیدها در لاگ.
- ذخیره `secrets` در env.
- فعال بودن rate limit.
- لاگ نکردن اطلاعات حساس.

## 8) UX و نمایش
- زبان: فارسی.
- لحن: رسمی و کمی صمیمی.
- نمایش مصرف: فقط عدد (بدون درصد).
- تاریخ‌ها: شمسی + میلادی.

## 9) اعلان‌ها
- هشدار مصرف کم: زیر 10٪.
- هشدار انقضا: 2 روز قبل.
- پیام پرداخت موفق.
- پیام پرداخت ناموفق.
- امکان خاموش‌کردن اعلان‌ها توسط کاربر: فعال.

## 10) موارد باقی‌مانده برای شروع پیاده‌سازی
برای شروع کدنویسی بدون ابهام، فقط این موارد باید نهایی شوند:
1. `telegram_bot_token`
2. `admin_telegram_id` (ادمین اصلی)
3. `second_admin_telegram_id` (در صورت نیاز به دسترسی مدیریتی)
4. `support_channel_username` یا `channel_id`
5. اطلاعات اتصال MySQL (`DB_HOST`, `DB_PORT`, `DB_NAME`, `DB_USER`, `DB_PASS`)
6. اطلاعات ورود پنل 3x-ui (`PANEL_URL`, `PANEL_USERNAME`, `PANEL_PASSWORD`)
7. لیست دقیق پلن‌ها (نام پلن + حجم + قیمت)
8. مشخصات پلن تست (حجم/مدت/قیمت)
9. اطلاعات کارت برای پرداخت دستی (شماره کارت + نام دارنده + متن راهنما)

---

در این مرحله، نیازمندی‌ها ثبت و فریز شده‌اند و می‌توان وارد فاز پیاده‌سازی شد.
